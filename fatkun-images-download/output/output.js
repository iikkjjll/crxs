var _config,gApp;navigator.userAgent.match("QQBrowser")&&document.body.classList.add("qq-browser");var newImgList=[],tabId=location.href.match(/tabId=(\d+)/);tabId=tabId?parseInt(tabId[1]):"";var tabTitle="",startedTabIds=[],outputType=location.href.match(/type=(.+?)(&|$)/),pageInfos=[];outputType&&(outputType=outputType[1]);var currentI18n={};function main(t){function e(t){chrome.runtime.sendMessage({cmd:"GET_ADVANCEC_IMGS",tabId:t.id},function(e){var i=e.map(function(t){return t.src});chrome.tabs.sendMessage(t.id,{cmd:"GET_IMAGE_FROM_BG3",tabInfo:t,imgReqList:i})})}document.title="drag"==outputType?currentI18n.outputDragDownloadTitle:currentI18n.outputPageTitle,chrome.runtime.onMessage.addListener(function(t,e,i){if(!tabId||t.tabId==tabId||e.tab.id==tabId)if("ADD_IMG"==t.cmd)if(outputType){if(t.type==outputType&&(n.addItem(t.item),"drag"==t.type)){var s=document.title;document.title=currentI18n.new_image_added,favico=document.getElementById("favico"),favico.href=t.item.smallUrl,setTimeout(function(){document.title=s,favico.href="../icon-small.png"},2e3)}}else t.type||n.addItem(t.item);else if("ADD_IMG_LIST"==t.cmd)!function(t,e){function i(s){n++,s?"string"==typeof s?new ParsedPItem({src:s},n,e.tab,e.frameId,function(e){gApp.addItem(e),n<t.length&&i(t[n])}):"VIDEO"==s.type?new VItem(s,n,e.tab,e.frameId,function(e){gApp.addItem(e),n<t.length&&i(t[n])}):new ParsedPItem(s,n,e.tab,e.frameId,function(e){gApp.addItem(e),n<t.length&&i(t[n])}):n<t.length&&i(t[n])}t=t.filter(function(t){return!!t});for(var n=0,s=0;s<10;s++)i(t[n])}(t.list,e);else if("ADD_VIDEO"==t.cmd)n.addItem(t.item);else if("SET_GROUPS"==t.cmd)n.groups2=t.groups;else if("SET_PAGE_INFO"==t.cmd){for(var o=0;o<pageInfos.length;o++)if(pageInfos[o].tabId==e.tab.id){pageInfos.splice(o,1);break}pageInfos.push({tabId:e.tab.id,value:t.pageInfo})}else"SET_HEADERS"==t.cmd?(setHeaders(t.headers),i&&i()):"SET_CROSS_DOMAIN"==t.cmd?(setCrossDomain(),i&&i()):"SUPPORT_COLLECT_PAUSE"==t.cmd?gApp.supportcollectpause=!0:"COLLECT_COMPLETED"==t.cmd&&(gApp.collectCompleted=!0);return!0}),window.addEventListener("resize",function(){n.winInnerWidth=Math.max(i,window.innerWidth-("left"==gConfig.topOrLeft?210:0)),n.winInnerHeight=window.innerHeight});var i=1280;var n=gApp=new Vue({el:"#app",data:{imgList:[],groups1:[],groups2:[],maxWidth:t.rememberFilter&&t.widthRange?t.widthRange[1]||t.widthRange[0]:0,maxHeight:t.rememberFilter&&t.heightRange?t.heightRange[1]||t.heightRange[0]:0,minInnerWidth:i,winInnerWidth:Math.max(i,window.innerWidth-("left"==gConfig.topOrLeft?210:0)),winInnerHeight:window.innerHeight,urlfilter:"",sortType:"default",showSort:!1,config:t,showOutputTextPanel:!1,downloader:downloader,viewModel:"normal",i18n:currentI18n,currentPage:1,selectionBoxStyling:{},startedTabs:[],selectedTabs:"",showSaveTips:!1,saveTipsDoNotShowAgain:JSON.parse(localStorage.saveTipsDoNotShowAgain||"false"),widthRange:t.rememberFilter&&t.widthRange?[t.widthRange[0],t.widthRange[1]||t.widthRange[0]]:[0,0],heightRange:t.rememberFilter&&t.heightRange?[t.heightRange[0],t.heightRange[1]||t.heightRange[0]]:[0,0],renameInputFocused:!1,filterInputFocused:!1,showRenameDialog:!1,editingRenameRule:t.renameRule,showRenameRuleDetail:!1,brand:gConfig.brand,gConfig:gConfig,topOrLeft:gConfig.topOrLeft,name:gConfig.name,stzsLink:"https://chrome.google.com/webstore/detail/kldhhobmmejaeaiilomaibhjlcfpceac?authuser=2&hl="+navigator.language,stzsen:!1,stzsAdClicked:!0,adBtnClicked:localStorage.outputAdBtnClicked,adLink:"http://ad.image-search-assistant.com/ad/stad.html?from=output-"+gConfig.name+"&"+utils.param(gParams),supportcollectpause:!1,collectPaused:!1,collectCompleted:!1},computed:{fixTopHeight:function(){return"left"==gConfig.topOrLeft?0:this.config.showMore?80:40},itemStyle:function(){return this.config.pagination&&this.bigView&&"spread"!=this.viewModel?{width:this.itemWidth-10+"px",height:this.itemWidth-10+"px"}:{}},showPagination:function(){return this.config.pagination&&"normal"==this.viewModel&&this.showImgList.length>this.pageSize},mainContentHeight:function(){return this.winInnerHeight-this.fixTopHeight-(this.showPagination?60:0)},picListWidth:function(){return this.itemWidth*parseInt(this.winInnerWidth/this.itemWidth)},contentHeight:function(){return this.winInnerHeight-this.fixTopHeight-30-60},showPagination:function(){return this.config.pagination&&"normal"==this.viewModel&&0==this.groups.length},itemWidth:function(){if(this.showPagination){var t=parseInt(this.contentHeight/250);return this.contentHeight%250>125?this.bigView?parseInt(this.contentHeight/(t+1)):130:this.bigView?250:130}return this.bigView?250:130},pageSize:function(){return parseInt(window.innerWidth/this.itemWidth)*parseInt(this.contentHeight/this.itemWidth)},groups:function(){return this.groups2.length>0?this.groups2:this.groups1},needRename:{get:function(){return t.needRename},set:function(e){t.needRename=e,appConfig.setConfig(t)}},renameRule:{get:function(){return t.renameRule},set:function(e){t.renameRule=e,appConfig.setConfig(t)}},bigView:{get:function(){return"big"==t.previewSize}},unique:{get:function(){return t.unique},set:function(e){t.unique=e,appConfig.setConfig(t)}},concurrent:{get:function(){return t.limitConcurrent},set:function(e){t.limitConcurrent=e,appConfig.setConfig(t)}},rememberFilter:{get:function(){return t.rememberFilter},set:function(e){t.rememberFilter=e,appConfig.setConfig(t)}},outputTextFormat:{get:function(){return t.outputTextFormat},set:function(e){t.outputTextFormat=e,appConfig.setConfig(t)}},showImgList:function(){var t=this,e=[],i=this.urlfilter.replace("，",",").split(",").join(".*");this.imgList.forEach(function(n){n.originalUrl&&t.checkSize(n)&&(0==t.selectedTabs.length||t.selectedTabs.indexOf(n.tabId)>=0)&&n.originalUrl.match(i)&&e.push(n)}),this.config.unique&&(e=_.uniqWith(e,function(t,e){var i=t.bigUrl||t.originalUrl,n=e.bigUrl||e.originalUrl;return t.group==e.group&&i==n}));var n=this.sortType;return"default"==n?e.sort(function(t,e){return t.tabIndex!=e.tabIndex?t.tabIndex-e.tabIndex:t.index-e.index}):"site"==n||("bigFirst"==n?e.sort(function(t,e){return e.size-t.size}):"smallFirst"==n&&e.sort(function(t,e){return t.size-e.size})),e.forEach(function(t,e){t.showIndex=e}),e},currentPageImgs:function(){return this.config.pagination&&"spread"!=this.viewModel?this.showImgList.slice(this.pageSize*(this.currentPage-1),this.pageSize*this.currentPage):this.showImgList},selectedImgs:function(){var t=[];return this.showImgList.forEach(function(e){e.selected&&(e.selectIndex=t.length,t.push(e))}),t},groupedImgs:function(){var t=this,e=this.groups.map(function(e){return{title:e,imgs:_.filter(t.showImgList,{group:e})}});_.remove(e,function(t){return 0==t.imgs.length});var i=_.filter(t.showImgList,{group:""});i.length>0&&e.push({title:this.i18n.others,imgs:i});var n=0;return e.forEach(function(t){t.imgs.forEach(function(t,e){t.showIndex=n,t.grouIndex=e,n++})}),e},downloadedImgs:function(){var t=[];return this.showImgList.forEach(function(e){"complete"==e.status&&t.push(e)}),t},interruptedImgs:function(){var t=[];return this.showImgList.forEach(function(e){"interrupted"==e.status&&t.push(e)}),t},outputText:function(){var t=this.config.outputTextFormat,e=[];return this.selectedImgs.forEach(function(i,n){var s=i.bigUrl,o=utils.replaceVarible({text:t,index:n,link:s});e.push(o)}),e.join("\n")},downloaderStatus:function(){return downloader.status}},mounted:function(){var i=this;if(!location.href.match("justopen=1")){if(tabId)chrome.tabs.get(tabId,function(t){tabTitle=t.title,document.title=tabTitle,e(t)});else{function n(){var t=JSON.parse(localStorage.imageTabIds||"[]");t.length>startedTabIds.length&&(t.slice(startedTabIds.length).forEach(function(t){chrome.tabs.get(t,function(t){utils.checkTabDownloadableByUrl(t.url)&&(e(t),t.shortTitle=t.title.length<40?t.title:t.title.substr(0,20)+"..."+t.title.substr(-20),i.startedTabs.push(t))})}),startedTabIds=t)}n(),setInterval(n,1e3)}var s=0,o=0,a=!1,r=document.querySelector("#main-content"),h=document.querySelector("#pic-list");addWheelListener(r,function(t){"spread"!=this.viewModel&&this.config.pagination&&(a||(s+=t.deltaY,o+=t.deltaX,0==s&&setTimeout(function(){s=0},1e3),0==o&&setTimeout(function(){deltaX=0},1e3),s>=300&&r.scrollTop+r.offsetHeight>=h.offsetHeight&&(this.currentPage<Math.ceil(this.showImgList.length/this.pageSize)&&(this.currentPage++,r.scrollTop=0),s=0,a=!0,setTimeout(function(){a=!1},500)),s<=-300&&0==r.scrollTop&&(this.currentPage>1&&(this.currentPage--,r.scrollTop=h.offsetHeight-r.offsetHeight),s=0,a=!0,setTimeout(function(){a=!1},500)),o>=300&&r.scrollLeft+r.offsetWidth>=h.offsetWidth&&(this.currentPage<Math.ceil(this.showImgList.length/this.pageSize)&&(this.currentPage++,r.scrollLeft=0),o=0,a=!0,setTimeout(function(){a=!1},500)),o<=-300&&0==r.scrollLeft&&(this.currentPage>1&&(this.currentPage--,r.scrollLeft=h.offsetWidth-r.offsetWidth),o=0,a=!0,setTimeout(function(){a=!1},500))))}.bind(this))}i=this;if(setInterval(function(){newImgList.length>0&&(i.imgList=i.imgList.concat(newImgList),newImgList=[])},1e3),t.dragSelect){var g,u;document.body.addEventListener("dragstart",function(t){t.preventDefault()});var d,c,l,f;function p(){d=0,c=0,l=0,f=0,g=null,u=null,i.selectionBoxStyling={}}function m(t){Math.abs(t.pageX-g.x)<10&&Math.abs(t.pageY-g.y)<10||(u={x:t.pageX,y:t.pageY},d=Math.min(g.y,u.y),c=Math.min(g.x,u.x),l=Math.abs(u.x-g.x),f=Math.abs(u.y-g.y),i.selectionBoxStyling={top:d+"px",left:c+"px",width:l+"px",height:f+"px"})}function w(){!1,window.removeEventListener("mousemove",m),window.removeEventListener("mouseup",w);var t=document.querySelector("#main-content");Math.abs(event.pageX-g.x)<10&&Math.abs(event.pageY-g.y)<10||(document.querySelectorAll(".img-item").forEach(function(e){if(utils.offset(e,"left")-t.scrollLeft+e.offsetWidth>c&&utils.offset(e,"top")-t.scrollTop+e.offsetHeight>d&&utils.offset(e,"left")-t.scrollLeft<c+l&&utils.offset(e,"top")-t.scrollTop<d+f){var n=_.find(i.showImgList,{id:e.id});n.selected=!n.selected}}),p())}p(),document.getElementById("main-content").addEventListener("mousedown",function(t){2!==t.button&&(!0,g={x:t.pageX,y:t.pageY},window.addEventListener("mousemove",m),window.addEventListener("mouseup",w))})}"jsds"==this.name&&(setInterval(()=>{this.stzsen=!this.stzsen},3e4),chrome.storage.local.get("stzsAdClicked",t=>{this.stzsAdClicked=!!t.stzsAdClicked}))},watch:{urlfilter:function(){this.currentPage=1},unique:function(){this.currentPage=1},saveTipsDoNotShowAgain:function(t){localStorage.saveTipsDoNotShowAgain=t},config:{handler:function(){appConfig.setConfig(this.config)},deep:!0}},methods:{addItem:function(t){("IMG"!=t.type||t.width&&t.height)&&(t.selected=!0,t.size=t.width*t.height,t.index=void 0!==t.index?t.index:this.imgList.length,t.status="added",t.w=t.width,t.h=t.height,t.src=t.bigUrl,t.id=t.tabIndex+"_"+t.frameId+"_"+t.index,newImgList.push(t),t.width>n.maxWidth&&(n.maxWidth=t.width,n.rememberFilter&&n.config.widthRange&&n.config.widthRange[1]?n.maxWidth>n.config.widthRange[1]&&(n.widthRange[1]=n.config.widthRange[1]):n.widthRange[1]=n.maxWidth),t.height>n.maxHeight&&(n.maxHeight=t.height,n.rememberFilter&&n.config.heightRange&&n.config.heightRange[1]?n.maxHeight>n.config.heightRange[1]&&(n.heightRange[1]=n.config.heightRange[1]):n.heightRange[1]=n.maxHeight),t.group&&-1==this.groups1.indexOf(t.group)&&(-1==t.groupIndex?this.groups1.push(t.group):this.groups1.splice(Math.min(t.groupIndex,this.groups1.length),0,t.group)),"drag"==outputType&&(document.title=t.docTitle))},checkSize:function(t){return"VIDEO"==t.type||(!this.widthRange||t.width>=this.widthRange[0]&&t.width<=this.widthRange[1])&&(!this.heightRange||t.height>=this.heightRange[0]&&t.height<=this.heightRange[1])},itemClick:function(t){var e=this.imgList.indexOf(t);t.selected=!t.selected,this.imgList.splice(e,1,t)},resetFilter:function(){this.config.widthRange=null,this.config.heightRange=null,appConfig.setConfig({widthRange:null,heightRange:null}),this.currentPage=1,this.widthRange=[0,this.maxWidth],this.heightRange=[0,this.maxHeight],this.urlfilter="",this.selectedTabs=""},resetWhRange:function(){this.config.widthRange=null,this.config.heightRange=null,appConfig.setConfig({widthRange:null,heightRange:null}),this.currentPage=1,this.widthRange=[0,this.maxWidth],this.heightRange=[0,this.maxHeight]},toggle:function(){this.showImgList.forEach(function(t){t.selected=!t.selected})},selectAll:function(){this.showImgList.forEach(function(t){t.selected=!0})},sortBy:function(t){this.sortType=t,this.showSort=!1},changeView:function(){this.viewModel="normal"==this.viewModel?"spread":"normal"},getDir:function(){return"FIXED"==t.dirType?t.fixedDir:tabTitle},realDowload:function(){this.imgList.forEach(function(t,e){t.status="added"}),downloader.init(t,function(t,e){e.status=t,this.imgList.splice(this.imgList.indexOf(e),1,e),this.downloadedImgs.length+this.interruptedImgs.length==this.selectedImgs.length&&(downloader.status="complete")}.bind(this)),downloader.download(this.selectedImgs)},download:function(){this.saveTipsDoNotShowAgain?this.realDowload():this.showSaveTips=!0,this.config.recordPageInfo&&"TITLE"==this.config.dirType&&this.recordPageInfo()},recordPageInfo:function(){var t=[];this.selectedImgs.forEach(function(e){-1==t.indexOf(e.tabId)&&t.push(e.tabId)}),t.forEach(function(t){chrome.tabs.get(t,function(e){var i=new Blob(["Page Url:\r\n",e.url,"\r\n"].concat(pageInfos.filter(function(e){return e.tabId==t}).map(function(t){return t.value})),{type:"text/plain"}),n=window.URL.createObjectURL(i);chrome.downloads.download({url:n,filename:utils.getSafeDir(e.title)+"/pageInfo.txt",saveAs:!1,conflictAction:"uniquify"},function(t){})})})},viewBig:function(t,e){var i=document.querySelectorAll(".pswp")[0],n={index:(this.currentPage-1)*this.pageSize+t};new PhotoSwipe(i,PhotoSwipeUI_Default,e||this.showImgList,n).init()},openLink:function(t){chrome.tabs.create({url:t})},share:function(t){var e={url:t.bigUrl,title:"#Fatkun批量下载图片#",pic:t.bigUrl},i=[];for(var n in e)i.push(n+"="+encodeURIComponent(e[n]||""));window.open("http://service.weibo.com/share/share.php?"+i.join("&"),"_blank","width=615,height=405")},downloadSingle:function(e){downloader.init(t,function(t,e){e.status=t,this.imgList.splice(this.imgList.indexOf(e),1,e)}.bind(this)),downloader.downloadSingle(e)},pauseDownload:function(){"paused"==downloader.status?downloader.resume():downloader.pause()},exportLinks:function(){this.showOutputTextPanel=!0},closeLinksPanel:function(){this.showOutputTextPanel=!1},resetOutputTextFormat:function(){this.outputTextFormat=appConfig.getDefaultConfig().outputTextFormat},changePage:function(t){this.currentPage=t},saveTipsClose:function(){this.showSaveTips=!1},saveTipsSave:function(){this.showSaveTips=!1,this.realDowload()},saveWidthRange:function(t){appConfig.setConfig({widthRange:[t[0],t[1]<n.maxWidth?t[1]:0]}),this.currentPage=1},saveHeightRange:function(t){appConfig.setConfig({heightRange:[t[0],t[1]<n.maxHeight?t[1]:0]}),this.currentPage=1},setMinWidth:function(t){this.widthRange=[t,this.widthRange[1]],appConfig.setConfig({widthRange:this.widthRange}),this.currentPage=1},setMaxWidth:function(t){this.widthRange=[this.widthRange[0],t],appConfig.setConfig({widthRange:this.widthRange}),this.currentPage=1},setMinHeight:function(t){this.heightRange=[t,this.heightRange[1]],appConfig.setConfig({heightRange:this.heightRange}),this.currentPage=1},setMaxHeight:function(t){this.heightRange=[this.heightRange[0],t],appConfig.setConfig({heightRange:this.heightRange}),this.currentPage=1},groupSelected:function(t,e){this.groupedImgs[t].imgs.forEach(function(t){t.selected=e})},downloadGroup:function(e){var i=this.groupedImgs[e].imgs;(i=_.filter(i,{selected:!0})).forEach(function(t,e){t.status="added"}),downloader.init(t,function(t,e){e.status=t,i.splice(i.indexOf(e),1,e),this.downloadedImgs.length+this.interruptedImgs.length==i.length&&(downloader.status="complete")}.bind(this)),downloader.download(i)},openSettingPage:function(){chrome.tabs.query({url:chrome.extension.getURL("settings/settings.htjl")},function(t){t.length>0?chrome.tabs.update(t[0].id,{active:!0}):chrome.tabs.create({url:chrome.extension.getURL("settings/settings.html")})})},stzsAdClick:function(){this.stzsAdClicked=!0,chrome.storage.local.set({stzsAdClicked:!0})},clickAdBtn:function(){setTimeout(function(){localStorage.outputAdBtnClicked=this.adBtnClicked=!0}.bind(this),1e3)},pauseCollect:function(){this.collectPaused=!this.collectPaused,chrome.tabs.sendMessage(tabId,{cmd:this.collectPaused?"PAUSE_COLLECT":"RESUME_COLLECT"})}}})}function setCrossDomain(){function t(t){return t.responseHeaders.push({name:"Access-Control-Allow-Origin",value:"*"}),{responseHeaders:t.responseHeaders}}try{chrome.webRequest.onHeadersReceived.addListener(t,{urls:["<all_urls>"]},["blocking","responseHeaders","extraHeaders"])}catch(e){chrome.webRequest.onHeadersReceived.addListener(t,{urls:["<all_urls>"]},["blocking","responseHeaders"])}}function setHeaders(t){var e=t.map(function(t){return t.name.toLowerCase()});function i(i){if(i.initiator&&i.initiator.indexOf(chrome.runtime.id)>0||gApp.imgList.map(t=>t.bigUrl).indexOf(i.url)>=0)return e.forEach(function(e,n){for(var s=0;s<i.requestHeaders.length;s++)i.requestHeaders[s].name.toLowerCase()==e&&(i.requestHeaders[s].value=t[n].value);s==i.requestHeaders.length&&i.requestHeaders.push(t[n])}),{requestHeaders:i.requestHeaders}}try{chrome.webRequest.onBeforeSendHeaders.addListener(i,{urls:["<all_urls>"]},["blocking","requestHeaders","extraHeaders"])}catch(t){chrome.webRequest.onBeforeSendHeaders.addListener(i,{urls:["<all_urls>"]},["blocking","requestHeaders"])}}appConfig.init(function(t){_config=t,bigImgParser.init(function(){utils.getI18n().then(e=>{for(var i in e)currentI18n[i]=e[i].message;main(t)})})}),setTimeout(function(){tj.send("page",{p:"output"})},2e3),document.body.addEventListener("click",function(t){var e=t.target.closest("[data-tj-btn]");e&&tj.send("btn",{p:"output",id:e.dataset.tjBtn})},!0);