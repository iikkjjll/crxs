var validShortKeyReg="[a-zA-z1-9]",gApp,currentI18n={};utils.getI18n().then(messages=>{for(var key in messages)currentI18n[key]=messages[key].message;document.title=currentI18n.settingsPageTitle,appConfig.init(function(config){var app=gApp=new Vue({el:"#app",data:{loading:!1,currentPage:"main-1",version:chrome.runtime.getManifest().version,config:config,aiscript:{current:null,newItem:null,status:"normal"},newAiscript:null,showSwitchOldMsg:!1,aiscriptEnabled:!1,i18n:currentI18n,commonRules:[],userRules:[],aiscripts:[],installedScripts:[],notInstalledScripts:[],i18n:currentI18n,addingDomain:"",brand:gConfig.brand,gConfig:gConfig},mounted:function(){var e=this;bigImgParser.init(function(){e.commonRules=bigImgParser.getCommonRules(),e.userRules=bigImgParser.getUserRules()}),aiscripts.init(function(t){e.aiscripts=t,fetch(gConfig.staticServer+"/aiscripts2/scripts.json?_="+Date.now()).then(function(e){return e.json()}).then(function(e){e.forEach(function(e,s){var n=t[s];n?n.text?utils.compareVersion(e.version,n.version)>0&&(n.latestVersion=e.version,n.latest=e):t[s]=new ScriptItem(e):t.push(new ScriptItem(e))})})})},watch:{config:{handler:function(){appConfig.setConfig(this.config)},deep:!0}},computed:{autoConvertWebp:{get:function(){return this.config.autoConvertWebp},set:function(e){this.config.autoConvertWebp=e,e&&chrome.tabs.query({url:chrome.extension.getURL("output/output.html*")},function(e){e.forEach(function(e){chrome.tabs.reload(e.id)})})}},shortKeyCurrent:{get:function(){return this.config.shortKeyCurrent.toUpperCase()},set:function(e){(e=(e=e.toUpperCase()).substr(-1,1))==this.config.shortKeyAll&&(e=""),e.match(validShortKeyReg)&&(e=e.toUpperCase()),this.config.shortKeyCurrent=e,e||(this.$refs.shortKeyCurrentEle.value=""),e==this.config.shortKeyCurrent&&(this.$refs.shortKeyCurrentEle.value=e)}},shortKeyAll:{get:function(){return this.config.shortKeyAll.toUpperCase()},set:function(e){(e=(e=e.toUpperCase()).substr(-1,1))==this.config.shortKeyCurrent&&(e=""),e.match(validShortKeyReg)&&(e=e.toUpperCase()),this.config.shortKeyAll=e,e||(this.$refs.shortKeyAllEle.value=""),e==this.config.shortKeyAll&&(this.$refs.shortKeyAllEle.value=e)}}},methods:{switchOnOff:function(e,t){},updateScript:function(){var e=this;this.loading=!0,aiscripts.update(this.aiscript.newItem,function(t){this.loading=!1,t&&t.success&&(e.aiscript.status="updated",chrome.tabs.reload(currentTab.id))})},checkAiscriptUpdate:function(){this.loading=!0,aiscripts.checkUpdate(this.aiscript.current.id,function(e){this.loading=!1,e.needUpdate?(this.aiscript.status="needUpdate",this.aiscript.newItem=e.newItem):this.aiscript.status="latest"}.bind(this))},switchContextmenu:function(){chrome.runtime.sendMessage({cmd:"SWITCH_CONTEXTMENU",enabled:this.config.enableContextmenu})},addRule:function(){this.userRules.push({site:"",srcPattern:"",replaceRule:""})},saveRules:function(){var e=[];this.userRules.forEach(function(t){t.site&&t.srcPattern&&t.replaceRule&&e.push(t)}),this.userRules=e,chrome.storage.local.set({userRules:this.userRules})},saveCommonRules:function(){chrome.storage.local.set({commonRules:this.commonRules})},deleteRule:function(e){this.userRules.splice(this.userRules.indexOf(e),1),chrome.storage.local.set({userRules:this.userRules})},test:function(rule){if(rule.site&&rule.srcPattern&&rule.replaceRule){var thumb_url=prompt("缩略图的网址","");if(thumb_url){var srcPattern=new RegExp(rule.srcPattern),replaceRule=rule.replaceRule,bigUrl;if(srcPattern&&srcPattern.test(thumb_url))try{bigUrl=eval(replaceRule.replace(/@/g,thumb_url)),window.open(bigUrl)}catch(e){alert("请检查图片链接替换代码")}else alert("图片链接匹配不正确")}}else alert("请先填写完整")},updateScript:function(e){aiscripts.update(e.latest,function(t){t.success&&(e.updated=!0)})},removeScript:function(e){},switchAiScript:function(e,t){e?aiscripts.enable(t,function(){}):aiscripts.disable(t,function(){})},addDomain:function(){var e=utils.getDomainFromUrl(this.addingDomain);-1==this.config.needBlobDomains.indexOf(e)&&this.config.needBlobDomains.push(e),this.addingDomain=""},removeDomain:function(e){var t=this.config.needBlobDomains;t.splice(t.indexOf(e),1)},openBrowserSetting:function(){chrome.tabs.create({url:"chrome://settings/downloads"})}}})})}),setTimeout(function(){tj.send("page",{p:"popup"})},2e3);