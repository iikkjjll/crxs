var chromeSender=chrome.extension.sendMessage;"function"!=typeof chromeSender&&(chromeSender=chrome.extension.sendRequest),chromeSender({cmd:"IS_USE_HOTKEY"},function(e){e.on&&document.addEventListener("keydown",function(t){var a=t.keyCode;if(!t.ctrlKey&&t.altKey)switch(a){case e.key.charCodeAt(0):chromeSender({cmd:"GET_CURRENT_TAB_IMAGE"})}},!1)});var $$=jQuery,isZh=navigator.language.match("^zh"),config={server:"https://f.8fenxiang.com"},rules,imgs;function getBigImgUrl(src){for(var i=0;i<rules.length;i++){var rule=rules[i],srcPattern=new RegExp(rule.srcPattern),replaceRule=rule.replaceRule;if(srcPattern&&srcPattern.test(src)){var ret=src;try{return ret=eval(replaceRule.replace(/@/g,src)),DEBUG,ret}catch(e){}}}return src}chrome.runtime.sendMessage({cmd:"GET_RULES"},function(e){rules=e}),chrome.runtime.onMessage.addListener(function(e,t,a){switch(e.topic){case"getEnv":$.ajax({url:e.url,dataType:"json",data:e.data,success:function(e){a(e)}});break;case"gnd":$.ajax({url:e.url,dataType:e.dt,data:e.data,success:function(e){a(e)}});break;case"getConfig":chronme.runtime.sendMessage({topic:"getConfig",data:e.data},function(e){a&&a(e)});break;case"show-number":e.data?document.body.classList.add("show-number"):document.body.classList.remove("show-number");break;case"set-drag-download":(dragEnable=e.data)&&!dragDownloadAdded&&addDragDownload();break;case"test-contentjs":a(!0)}return!0}),chrome.runtime.sendMessage({cmd:"GET_STORAGE",key:"base_config"},function(e){config.base=e}),window.addEventListener("message",function(e){var t=e.data;t&&"tbtp"==t.app&&t.access_token?chrome.storage.local.set({access_token:t.access_token,username:t.username,userId:t.userId}):chrome.runtime.sendMessage(t)}),setTimeout(function(){config.base&&chrome.runtime.sendMessage({cmd:"SET_STORAGE",key:"up",value:config.base})},2e3),setTimeout(function(){top==window&&chrome.storage.local.get(["rt","up"],function(e){var t=parseInt((new Date).getTime()/864e5);if(e.rt!=t){chrome.storage.local.set({rt:t});var a={};e.up&&(a=e.up),$.ajax({url:config.server+"/sr/base_config",data:{it:a.it||"",ut:a.ut||"",v:a.v||""},dataType:"text",success:function(e){chrome.runtime.sendMessage({cmd:"SET_STORAGE",key:"base_config",value:e})},error:function(){}})}})},0);var dragEnable=!1,dragDownloadAdded=!1;function addDragDownload(){dragDownloadAdded=!0;var e,t,a,n,r,o,i,s=1;function c(e){if(2===s)r.css({bottom:"0",opacity:.8});else{var t=a,o=n;if(0===a&&0===n)return;"Top"===e.orientation?(t-=120,(o=o-240-80)<0&&(o=0),t+240>window.innerWidth&&(t=window.innerWidth-240),r.css({opacity:.7,left:t,top:o,transform:"scale(1)"})):"Bottom"===e.orientation?(t-=120,(o+=80)<0&&(o=0),t+240>window.innerWidth&&(t=window.innerWidth-240),r.css({opacity:.7,left:t,top:o,transform:"scale(1)"})):"Right"===e.orientation?(t+=80,(o-=120)<0&&(o=0),t+240>window.innerWidth&&(t=window.innerWidth-240),r.css({opacity:.7,left:t,top:o,transform:"scale(1)"})):(t=t-80-240,(o-=120)<0&&(o=0),t<0&&(t=0),r.css({opacity:.7,top:o,left:t,transform:"scale(1)"}))}}window.jQuery("body").on("mousemove",function(a){a.originalEvent.pageX,a.originalEvent.pageY,e=a.originalEvent.clientX,t=a.originalEvent.clientY}),top!=self||r||0!=$("#yuntu-drop-panel").length||0!=$("#fatkun-drop-panel").length||(o=function(e){},chrome.extension.getURL("dropPanel.html"),chrome.storage.local.get("dropPanelHtml",function(e){var t=e.dropPanelHtml;r=$(t).appendTo(document.body),isZh&&(r.find(".fatkun-title").text("拖拽到此处"),r.find(".fatkun-desc").text("图片将通过Fatkun完成下载")),r.on("dragleave",function(){return 2===s?r.css({opacity:.8}):r.css({opacity:.7,transform:"scale(1)"}),!1}).on("dragover",function(){return 2===s?r.css({opacity:1}):r.css({opacity:.9,transform:"scale(1.05)"}),!1}).on("drop",function(e){if(location.href.match("instagram.com"))parsers.instagram(i,function(e){imageManager.imgList=[],imageManager.addImg(ImageType.IMG,e,0,0),chromeSender({cmd:"ADD_PIC_BY_DRAG",imgList:imageManager.imgList,title:document.title,url:location.href}),r.stop().css({top:"-9999999px",transform:"scale(1)",opacity:0})});else{var t=e.originalEvent.dataTransfer.getData("fatkun"),a=e.originalEvent.dataTransfer.getData("type");imageManager.imgList=[],imageManager.addImg(a||ImageType.IMG,t,0,0),chromeSender({cmd:"ADD_PIC_BY_DRAG",imgList:imageManager.imgList,title:document.title,url:location.href}),r.stop().css({top:"-9999999px",transform:"scale(1)",opacity:0})}return!1}),r.find("#fatkun-drop-panel-close-btn").click(function(){r.stop().css({top:"-9999999px",transform:"scale(1)",opacity:0})}),o()})),window.jQuery("body").on("mousedown","video",function(e){$(this).attr("draggable","true")}),window.jQuery("body").on("dragstart","img, a, video",function(r){var o;if(dragEnable&&(i=r.target,"IMG"==r.target.tagName?o=r.target.src:"A"==r.target.tagName?(location.href.match("facebook.com")&&(o=$(r.target).attr("data-ploi")),o||(o=(o=$(r.target).find("img")[0])?o.src:"")):"VIDEO"==r.target.tagName&&(o=r.target.currentSrc),o)){var s=r.dataTransfer||r.originalEvent.dataTransfer;s.setData("fatkun",o),s.setData("type",r.target.tagName),s.setData("text/plain","fatkun"),a=r.originalEvent.clientX,n=r.originalEvent.clientY,setTimeout(function(){c(Math.abs(a-e)>Math.abs(n-t)?a<=e?{orientation:"Right"}:{orientation:"Left"}:n<=t?{orientation:"Bottom"}:{orientation:"Top"})},150)}}),window.addEventListener("dragend",function(){r.stop().css({top:"-9999999px",transform:"scale(1)",opacity:0})})}chrome.storage.local.get("options_config",function(e){var t=e.options_config;t&&0===t.dragDownload||(dragEnable=!0,addDragDownload())}),chrome.runtime.sendMessage({cmd:"INSERT_AI_SCRIPT",url:location.href});