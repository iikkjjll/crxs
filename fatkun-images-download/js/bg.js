var aiscripts2=[];function insertCt(e,t,n){var s=!!navigator.userAgent.match("MetaSr");["lib/jQuery.js","lib/dom-to-image.min.js","js/utils.js","js/parsers.js","js/tj.js","js/config.js","js/appConfig.js","js/sites.js","js/item.js","js/dragdownload.js","js/bigImgParser.js"].forEach(function(n){chrome.tabs.executeScript(e.id,s?{file:n}:{file:n,frameId:t||0})}),chrome.tabs.executeScript(e.id,s?{file:"js/ct.js"}:{file:"js/ct.js",frameId:t||0},function(){n&&n(e,t||0)}),chrome.tabs.insertCSS(e.id,s?{file:"css/ct.css"}:{file:"css/ct.css",frameId:t||0}),chrome.tabs.insertCSS(e.id,s?{file:"css/droppanel.css"}:{file:"css/droppanel.css",allFrames:!0}),t||aiscripts.init(function(){})}function showAiScriptMsg(e,t){chrome.tabs.executeScript(e,{file:"lib/vue.min.js"}),chrome.tabs.executeScript(e,{file:"lib/vue-element/index.js"}),chrome.tabs.insertCSS(e,{file:"lib/vue-element/index.css"}),chrome.tabs.executeScript(e,{file:"messages/aiscriptMsg.js"},function(){chrome.tabs.executeScript(e,{code:"showAiScriptMsg("+JSON.stringify(t)+")"})})}function initAdvanceMode(){var e=[],t=[];function n(n){n.url;var s=n.tabId;-1!=s&&-1!=t.indexOf(s)&&e.push({src:n.url,tabId:s})}function s(t){chrome.tabs.query({},function(n){var s=n.map(function(e){return e.id}),o=[];e.forEach(function(e){s.indexOf(e.tabId)>=0&&-1==o.indexOf(e)&&o.push(e)}),t(o)})}function o(n,s,o){if(s&&s.url){t.push(o.id);var i=[];e.forEach(function(e){e.tabId!=n&&i.push(e)}),e=i}}return{status:"disabled",enable:function(){"disabled"==this.status&&(chrome.webRequest.onBeforeRequest.addListener(n,{urls:["<all_urls>"],types:["image"]}),chrome.tabs.onUpdated.addListener(o),this.status="enabled")},disable:function(){"enabled"==this.status&&(chrome.webRequest.onBeforeRequest.removeListener(n),chrome.tabs.onUpdated.removeListener(o),this.status="disabled")},getOneTabImages:function(e,t,n){var o=[];s(function(e){e.forEach(function(e,n){e.tabId==t&&o.push(e)}),n(o)})},getAllTabImages:function(e){s(function(e){var t=[];e.forEach(function(e,n){t.push(e)}),cb(t)})}}}chrome.runtime.onMessage.addListener(function(e,t,n){switch(e.cmd){case"INSERT_CT":insertCt(t.tab,t.frameId,n);break;case"ENABLE_AISCRIPT":aiscripts.enable(e.id,function(){chrome.tabs.reload(t.tab.id)});break;case"UPDATE_AISCRIPT":aiscripts.update(e.newItem,function(){chrome.tabs.reload(t.tab.id)})}return!0});var _config,advancedMode=initAdvanceMode();appConfig.init(function(e){function t(e){var t=e.map(function(e){return e.id});chrome.tabs.query({url:chrome.extension.getURL("output/output.html")},function(e){0==e.length?(localStorage.imageTabIds=JSON.stringify(t),chrome.tabs.create({url:chrome.extension.getURL("output/output.html")})):(localStorage.imageTabIds=JSON.stringify(JSON.parse(localStorage.imageTabIds||"[]").concat(t)),chrome.tabs.update(e[0].id,{active:!0}))})}function n(e){e.forEach(function(e){var t="output/output.html",n=[];n.push("tabId="+e.id),n.length>0&&(t+="?"+n.join("&")),chrome.tabs.create({url:t})})}function s(){chrome.tabs.query({active:!0,windowId:chrome.windows.WINDOW_ID_CURRENT},function(e){o(e[0])})}function o(s){e.singleOutput?t([s]):n([s])}var i;function a(e){e?i=chrome.contextMenus.create({title:"批量下载",type:"normal",contexts:["all"],onclick:function(e,t){o(t),tj.send("dl",{tab:"one",from:"contextmenu"})}}):chrome.contextMenus.remove(i)}_config=e,e.advancedMode&&advancedMode.enable(),downloader.init(e,function(e){}),chrome.runtime.onMessage.addListener(function(o,i,c){switch(o.cmd){case"GET_CURRENT_TAB_IMAGE":"popup"==o.from&&tj.send("dl",{tab:"one",from:"popup"}),s();break;case"GET_ALL_TAB_IMAGE":"popup"==o.from&&tj.send("dl",{tab:"all",from:"popup"}),chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT},function(s){e.singleOutput?t(s):n(s)});break;case"GET_ADVANCEC_IMGS":o.tabId?advancedMode.getOneTabImages(i.tab.id,o.tabId,c):advancedMode.getAllTabImages(i.tab.id,c);break;case"DOWNLOAD_BY_DRAG":"download-instantly"==e.dragDownloadMode?downloader.downloadSingle(o.item):(r=o.item,chrome.tabs.query({url:chrome.extension.getURL("/output/output.html?justopen=1&type=drag"),windowId:chrome.windows.WINDOW_ID_CURRENT},function(e){0==e.length?chrome.tabs.create({url:chrome.extension.getURL("/output/output.html?justopen=1&type=drag")},function(e){setTimeout(function(){chrome.tabs.sendMessage(e.id,{type:"drag",cmd:"ADD_IMG",item:r})},2e3)}):chrome.tabs.sendMessage(e[0].id,{type:"drag",cmd:"ADD_IMG",item:r})}));break;case"SWITCH_CONTEXTMENU":a(o.enabled);break;case"OPEN-OUTPUT":!function(e,t,n){var s=chrome.extension.getURL("/output/output.html?justopen=1&type="+e+"&tabId="+(n||""));chrome.tabs.query({url:s,windowId:chrome.windows.WINDOW_ID_CURRENT},function(e){e.length>0?(chrome.tabs.update(e[0].id,{active:!0}),t()):chrome.tabs.create({url:s},function(){t()})})}(o.type,c,i.tab.id)}var r;return!0}),e.enableContextmenu&&a(!0),tj.send("config",e),"no"==gConfig.popupMode?chrome.browserAction.onClicked.addListener(function(e){s()}):chrome.browserAction.setPopup({popup:"popup/popup.html"})},function(e){e.advancedMode?advancedMode.enable():advancedMode.disable()}),bigImgParser.init_(function(e){}),$.ajax({url:chrome.extension.getURL("dropPanel.html"),success:function(e){chrome.storage.local.set({dropPanelHtml:e})}}),chrome.runtime.onMessage.addListener(function(e,t,n){if("GET_STORAGE"==e.cmd)chrome.storage.local.get(e.key,function(t){n(utils.parseJSON(t[e.key]))});else if("SET_STORAGE"==e.cmd){var s={};s[e.key]=e.value,chrome.storage.local.set(s)}else"NET"==e.cmd?$.ajax($.extend({},e.settings,{success:function(e){n({status:"ok",data:e})},error:function(){n({status:"error"})}})):"SILENT_DOWNLOAD"==e.cmd?e.imgs.forEach(function(e){var t={url:e.url,saveAs:!1,conflictAction:"uniquify"};e.filename&&(t.filename=e.filename),chrome.downloads.download(t)}):"GET_COOKIE"==e.cmd?chrome.cookies.getAll(e.details,function(e){n(e)}):"GA"==e.cmd&&_gaq.push(["_trackEvent",e.category,e.action,e.opt_label,null,!1]);return!0}),chrome.tabs.query({},function(e){e.forEach(function(e){chrome.tabs.sendMessage(e.id,{cmd:"CHECK_INIT_CT"},function(t){!chrome.runtime.lastError&&t||chrome.tabs.executeScript(e.id,{file:"js/initCt.js"},function(){})})})}),setTimeout(function(){tj.send("active")},5e3),chrome.storage.local.get("aiscripts2",function(e){var t=e.aiscripts2||[];0==t.length?aiscripts.init_():$.ajax({url:gConfig.staticServer+"/aiscripts2/scripts.json?_="+Date.now(),dataType:"json",success:function(e){e.forEach(function(e,n){var s=_.find(t,{id:e.id});s&&s.text?(utils.compareVersion(e.version,s.version)>0&&(s.latestVersion=e.version,s.latest=e),aiscripts2.push(s)):aiscripts2.push(e)}),chrome.storage.local.set({aiscripts2:aiscripts2}),aiscripts.init(function(){aiscripts2.forEach(e=>{e.text?e.latest&&aiscripts.update(e.latest):aiscripts.enable(e.id,function(){})})})}})});