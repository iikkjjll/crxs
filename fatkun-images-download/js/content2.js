var DEBUG=!1;String.prototype.endWith=function(e){return!(null==e||""==e||null==this||0==this.length||e.length>this.length)&&this.substring(this.length-e.length).toLowerCase()==e.toLowerCase()};var ImageType={IMG:"IMG",TEXT:"TEXT",LINK:"LINK",INPUT_IMG:"INPUT_IMG"},chromeSender=chrome.extension.sendMessage;"function"!=typeof chromeSender&&(chromeSender=chrome.extension.sendRequest);var ImageManager=function(){};function getallBgimages(){var e,t=[],i=document.getElementsByTagName("*");for(i=t.slice.call(i,0,i.length);i.length;)(e=document.deepCss(i.shift(),"background-image"))&&(e=/url\(['"]?([^")]+)/.exec(e)||[]),(e=e[1])&&-1==t.indexOf(e)&&(t[t.length]=e);return t}function addMark(e,t){e.dataset.fmark&&$("#fmark-"+t.mark).remove(),e.setAttribute("data-fmark",t.mark);var i=$(e).offset();$('<div class="fmark" id="fmark-'+t.mark+'">'+t.mark+"</div>").appendTo(document.body).css({position:"absolute",left:i.left+"px",top:i.top+"px",zIndex:2147483647,background:"rgba(0, 0, 0, .7)",textAlign:"center",lineHeight:"24px",height:"24px",color:"#fff",padding:"0 4px"})}document.deepCss=function(e,t){if(!e||!e.style)return"";var i=t.replace(/\-([a-z])/g,function(e,t){return t.toUpperCase()});if(e.currentStyle)return e.style[i]||e.currentStyle[i]||"";var a=document.defaultView||window;return e.style[i]||a.getComputedStyle(e,"").getPropertyValue(t)||""},Array.prototype.indexOf=Array.prototype.indexOf||function(e,t){t=t||0;for(var i=this.length;t<i;){if(this[t]===e)return t;++t}return-1},ImageManager.prototype={imgList:[],config:{},setConfig:function(e){$.extend(this.config,e)},getImage:function(config){this.imgList=[],$.extend(this.config,eval(config));var _this=this;if("undefined"==typeof aiparser){if(location.href.match(/image.baidu.com\/search\/index/))return $(".imgitem").each(function(){var e=$(this);_this.imgList.push({type:"IMG",src:e.attr("data-objurl"),smallImg:e.attr("data-thumburl"),width:e.attr("data-width"),height:e.attr("data-height"),ref:location.href,tabIndex:_this.config.tabIndex})}),void chromeSender({cmd:"ADD_PIC",outputTabId:this.config.outputTabId,imgList:this.imgList});if(location.href.match(/www\.google\..*\/search\?/))return $("#rg [jscontroller]").each(function(){var e=$(this),t=JSON.parse(e.find(".rg_meta")[0].innerText);_this.imgList.push({type:"IMG",src:t.ou,smallImg:e.find(".rg_ic").attr("src"),width:t.ow,height:t.oh,ref:location.href,tabIndex:_this.config.tabIndex})}),void chromeSender({cmd:"ADD_PIC",outputTabId:this.config.outputTabId,imgList:this.imgList});if(location.href.match(/^https?:\/\/www.pinterest/)){var initialState=document.getElementById("initial-state");if(initialState&&(initialState=JSON.parse(initialState.innerText),initialState.location.pathname==location.pathname&&initialState.resources.data.BoardPageResource)){var key=Object.keys(initialState.resources.data.BoardPageResource)[0],boardPage=initialState.resources.data.BoardPageResource[key].data,bookmarks="";function getPin(){var e={options:{isPrefetch:!1,board_id:boardPage.id,board_url:boardPage.url,field_set_key:"react_grid_pin",filter_section_pins:!0,layout:"default",page_size:25,redux_normalize_feed:!0},context:{}};bookmarks&&(e.options.bookmarks=bookmarks),$.ajax({url:location.protocol+"//"+location.host+"/resource/BoardFeedResource/get/",data:{source_url:location.pathname,data:JSON.stringify(e)},success:function(e){var t=e.resource_response.data;t.length>0&&(t.forEach(function(e){e.images&&_this.imgList.push({type:"IMG",src:e.images.orig.url,smallImg:e.images["236x"].url,width:e.images.orig.width,height:e.images.orig.height,ref:location.href,tabIndex:_this.config.tabIndex})}),chromeSender({cmd:"ADD_PIC",outputTabId:_this.config.outputTabId,imgList:_this.imgList}),bookmarks=e.resource.options.bookmarks,getPin())}})}return void getPin()}}else if(location.href.match(/(meiwu\.co|huaban\.com|huabanpro\.com)\/boards\/\d+/)){var max="",uniqueID="",script=document.createElement("script");script.innerText='(function(){document.body.setAttribute("uniqueID", String.uniqueID())})();',document.body.appendChild(script);var boardID=location.href.match(/boards\/(\d+)/)[1];function get(){$.ajax({url:location.protocol+"//"+location.host+"/boards/"+boardID+"/?"+uniqueID+(max?"&max="+max:"")+"&limit=20&wfl=1",success:function(e){if(e.board){var t=e.board.pins;t.forEach(function(e){_this.imgList.push({type:"IMG",src:"http://img.hb.aicdn.com/"+e.file.key,smallImg:"http://img.hb.aicdn.com/"+e.file.key+"_fw236",width:e.file.width,height:e.file.height,ref:location.href,tabIndex:_this.config.tabIndex,ext:e.file.type.replace("image/","")})}),chromeSender({cmd:"ADD_PIC",outputTabId:_this.config.outputTabId,imgList:_this.imgList}),t.length>0&&(max=t[t.length-1].pin_id,setTimeout(get,500))}else setTimeout(get,500)}})}return void setTimeout(function(){uniqueID=document.body.getAttribute("uniqueID"),get()},1e3)}if(_this.config.bg_more)chrome.runtime.sendMessage({cmd:"GET_IMG"},function(e){e.forEach(function(e){_this.addImg(ImageType.IMG,e.src,0,0)}),chromeSender({cmd:"ADD_PIC",outputTabId:_this.config.outputTabId,imgList:_this.imgList})});else if("enabled"==_this.config.aidownload&&location.href.match(/https?:\/\/detail.tmall.com|https?:\/\/item.taobao.com/)&&top==self){var itemImgs=document.querySelectorAll("#J_UlThumb img"),colorImgs=document.querySelectorAll(".J_TSaleProp a"),descImgs=document.querySelectorAll("#description img");itemImgs.forEach(function(e){addMark(e,_this.addImg(ImageType.IMG,e.src,0,0))}),colorImgs.forEach(function(e){var t=e.style.backgroundImage.match(/(\/\/.*)"/);t&&(t=t=location.protocol+t[1],addMark(e,_this.addImg(ImageType.IMG,t,0,0,e.parentNode.title)))}),descImgs.forEach(function(e){e.src.match("img-tmdetail.alicdn.com/tps/i3/T1BYd_XwFcXXb9RTPq-90-90.png")||e.src.match("spaceball.gif")||addMark(e,_this.addImg(ImageType.IMG,e.src,0,0))});var scripts=document.querySelectorAll("script"),imgVedioID,userId;if(location.href.match(/detail.tmall.com/)){for(var i=0;i<scripts.length;i++)if(scripts[i].innerText&&(imgVedioID=scripts[i].innerText.match(/"imgVedioID":"(\d+)"/),imgVedioID&&(imgVedioID=imgVedioID[1],userId=scripts[i].innerText.match(/"userId":"(\d+)"/),userId=userId?userId[1]:"",imgVedioID&&userId))){var videoUrl="https://cloud.video.taobao.com/play/u/"+userId+"/p/1/e/6/t/1/"+imgVedioID+".mp4";_this.addImg("VIDEO",videoUrl,0,0);break}}else if(location.href.match(/item.taobao.com/)){var meta=document.querySelector('meta[name="microscope-data"]');if(meta&&(userId=meta.content.match(/userid=(\d+);/),userId)){userId=userId[1];for(var i=0;i<scripts.length;i++)if(scripts[i].innerText&&!imgVedioID&&(imgVedioID=scripts[i].innerText.match(/"videoId":"(\d+)"/),imgVedioID)){imgVedioID=imgVedioID[1];var videoUrl="https://cloud.video.taobao.com/play/u/"+userId+"/p/1/e/6/t/1/"+imgVedioID+".mp4";_this.addImg("VIDEO",videoUrl,0,0);break}}}chromeSender({cmd:"ADD_PIC",outputTabId:_this.config.outputTabId,imgList:_this.imgList})}else{if("enabled"!=_this.config.aidownload||!location.href.match(/https?:\/\/detail.1688.com/)||top!=self){if("enabled"==_this.config.aidownload&&location.href.match("^https?://www.weibo.com/(?:\\d+/[a-zA-Z0-9]+(?:\\?|$)|u/\\d+)")&&top==self){var itemImgs=document.querySelectorAll(".WB_pic img, .choose_box img");return itemImgs.forEach(function(e){addMark(e,_this.addImg(ImageType.IMG,e.src,0,0))}),void chromeSender({cmd:"ADD_PIC",outputTabId:_this.config.outputTabId,imgList:_this.imgList})}var imgs=document.getElementsByTagName("img"),_this=this;if(location.href.match("facebook\\.com"))for(var i=0;i<imgs.length;i++){var img=imgs[i],src=$(img).closest("a").attr("data-ploi")||img.src,item=this.addImg(ImageType.IMG,src,0,0,img.getAttribute("alt"));addMark(img,item)}else{if(location.href.match("instagram.com")){for(var _this=this,parsedImgs=[],i=0;i<imgs.length;i++){var img=imgs[i];parsers.instagram(img,function(e){parsedImgs.push(e),parsedImgs.length==imgs.length&&parsedImgs.forEach(function(e){var t=_this.addImg(ImageType.IMG,e,0,0);addMark(img,t),chromeSender({cmd:"ADD_PIC",outputTabId:_this.config.outputTabId,imgList:_this.imgList})})})}return}for(var i=0;i<imgs.length;i++){var img=imgs[i],newImg=new Image;newImg.src=img.src;var width=0,height=0;width=parseInt(img.naturalWidth),height=parseInt(img.naturalHeight),nwidth=parseInt(newImg.width),nheight=parseInt(newImg.height),width=nwidth>width?nwidth:width,height=nheight>height?nheight:height,newImg=null;var item=this.addImg(ImageType.IMG,img.src,0,0,img.getAttribute("alt"));addMark(img,item)}}for(var inputs=document.getElementsByTagName("input"),i=0;i<inputs.length;i++){var input=inputs[i],type=input.type;if("IMAGE"==type.toUpperCase()){var src=input.src;this.addImg(ImageType.INPUT_IMG,src,0,0)}}for(var links=document.getElementsByTagName("a"),i=0;i<links.length;i++){var link=links[i],href=link.href;(href.endWith(".jpg")||href.endWith(".jpeg")||href.endWith(".bmp")||href.endWith(".ico")||href.endWith(".gif")||href.endWith(".png"))&&this.addImg(ImageType.LINK,href,0,0)}return chromeSender({cmd:"ADD_PIC",outputTabId:this.config.outputTabId,imgList:this.imgList}),this.imgList}var itemImgs=document.querySelectorAll("#dt-tab img"),colorImgs=document.querySelectorAll(".obj-leading img,.table-sku img"),descImgs=document.querySelectorAll(".de-description-detail img");itemImgs.forEach(function(e){addMark(e,_this.addImg(ImageType.IMG,e.src,0,0))}),colorImgs.forEach(function(e){addMark(e,_this.addImg(ImageType.IMG,e.src,0,0,e.alt))}),descImgs.forEach(function(e){addMark(e,_this.addImg(ImageType.IMG,e.src,0,0,"undefined"==e.alt?"":e.alt))});var detailGalery=document.querySelector(".mod-detail-gallery"),detailGaleryConfig;if(detailGalery&&(detailGaleryConfig=JSON.parse(detailGalery.dataset.modConfig),detailGaleryConfig.userId&&detailGaleryConfig.mainVideoId)){var videoUrl="https://cloud.video.taobao.com/play/u/"+detailGaleryConfig.userId+"/p/1/e/6/t/1/"+detailGaleryConfig.mainVideoId+".mp4";_this.addImg("VIDEO",videoUrl,0,0)}chromeSender({cmd:"ADD_PIC",outputTabId:_this.config.outputTabId,imgList:_this.imgList})}}else aiparser()},addImg:function(e,t,i,a,r){var o=this.getBigImgUrl(t);o!=t&&(t=o,0);var n={type:e,src:t,width:0,height:0,ref:location.href,tabIndex:this.config.tabIndex,alt:r,mark:"T_"+this.config.tabIndex+"_"+this.imgList.length};return this.imgList.push(n),n},getBigImgUrl:function(src){for(var rules=this.config.rules,i=0;i<rules.length;i++){var rule=rules[i],srcPattern=new RegExp(rule.srcPattern),replaceRule=rule.replaceRule;if(srcPattern&&srcPattern.test(src)){var ret=src;try{return ret=eval(replaceRule.replace(/@/g,src)),ret}catch(e){}}}return src}};var imageManager=new ImageManager;chrome.runtime.sendMessage({cmd:"GET_CONFIG"},function(e){imageManager.setConfig(e),e.showNumber&&document.body.classList.add("show-number")});