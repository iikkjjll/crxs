var myFixedName=chrome.i18n.getMessage("default_title"),optionOp={bind:function(){var e=this;$("#btnSave").click(function(){e.save_options()}),$("#btnRuleUpdate").click(function(){e.updateRule()}),$("#btnAddUserRule").click(function(){e.addUserRule("","","")}),$("#btnImportUserRule").click(function(){}),$("#user_rule_wrap .btn_del").live("click",function(){$(this).parent().parent().remove()}),$("#user_rule_wrap .btn_test").live("click",function(){var t=$(this).parent().parent();e.testUserRule(t)}),window.addEventListener("message",function(e){if(null!=e.data.ret){var t=e.data.ret;window.open(t)}})},testUserRule:function(e){var t=this.getUserRuleByHtml(e);if(this.vaildateUserRule(t)){var a=prompt("缩略图的网址","");if(a){var o=new RegExp(t.srcPattern),r=t.replaceRule;if(o&&o.test(a)){var n=document.getElementById("sandboxFrame"),l={command:"eval",content:r.replace(/@/g,a)};n.contentWindow.postMessage(l,"*")}else alert("图片链接匹配不正确")}}else alert("请先填写完整")},updateRule:function(){$("#ruleUpdateInfo").text("更新中...");var e=this;G_CONFIG.updateCommonRule({callback:function(){e.showRuleInfo()}})},save_options:function(){localStorage.min_width=document.getElementById("min_width").value,localStorage.min_height=document.getElementById("min_height").value;var e=$("#useTitle").attr("checked"),t=$("#useFixedName").attr("checked");e?localStorage.savePathType="useTitle":t&&(localStorage.savePathType="useFixedName"),""==$("#pathName").val()&&$("#pathName").val(myFixedName),localStorage.fixedName=$("#pathName").val(),localStorage.showUrl=$("#showUrl").attr("checked")?"1":"0",localStorage.useHotkey=$("#useHotkey").attr("checked")?"1":"0",localStorage.oneOutput=$("#oneOutput").attr("checked")?"1":"0",localStorage.dragSelect=$("#dragSelect").attr("checked")?"1":"0";var a=$("#dragDownload").attr("checked")?1:0,o=$("#autoConvertWebp").attr("checked")?1:0;chrome.storage.local.set({options_config:{dragDownload:a,autoConvertWebp:o}},function(){chrome.tabs.query({},function(e){e.forEach(function(e){chrome.tabs.sendMessage(e.id,{topic:"set-drag-download",data:a})})})}),this.saveUserRule();var r=document.getElementById("status");r.style.display="block",r.innerHTML=MSG("settings_already_save","设置已经保存了！"),setTimeout(function(){r.innerHTML="",r.style.display="none"},2e3)},restore_options:function(){$("#min_width").val(parseInt(localStorage.min_width||0)),$("#min_height").val(parseInt(localStorage.min_height||0)),$("#"+localStorage.savePathType).attr("checked","checked"),"1"==localStorage.showUrl&&$("#showUrl").attr("checked","checked"),"1"!=localStorage.useHotkey&&void 0!=localStorage.useHotkey||$("#useHotkey").attr("checked","checked"),"1"!=localStorage.oneOutput&&void 0!=localStorage.oneOutput||$("#oneOutput").attr("checked","checked"),"1"!=localStorage.dragSelect&&void 0!=localStorage.dragSelect||$("#dragSelect").attr("checked","checked"),chrome.storage.local.get("options_config",function(e){var t=e.options_config;t&&0===t.dragDownload||$("#dragDownload").attr("checked","checked"),t&&0===t.autoConvertWebp||$("#autoConvertWebp").attr("checked","checked")}),void 0==localStorage.fixedName||""==localStorage.fixedName?$("#pathName").val(myFixedName):$("#pathName").val(localStorage.fixedName),this.showRuleInfo(),this.showUserRuleInfo()},showRuleInfo:function(){var e=$("#bigImageList");e.html(""),$.each(G_CONFIG.getCommonRules(),function(t,a){e.append('<span title="图片替换代码：'+a.replaceRule+'">'+a.site+"</span>"),e.append(", ")});try{$("#ruleUpdateInfo").text(MSG("settings_rule_last_update_time","最后更新时间：")+(void 0==localStorage.ruleLastUpdateTime?MSG("settings_rule_last_update_time_none","无"):new Date(localStorage.ruleLastUpdateTime).toLocaleString()))}catch(e){}},showUserRuleInfo:function(){var e=this;$("#user_rule_wrap tbody").html("");var t=G_CONFIG.getUserRules();0==t.length&&$("#user_rule_wrap tbody").html(chrome.i18n.getMessage("settings_rules_empty")),$.each(t,function(t,a){e.addUserRule(a.site,a.srcPattern,a.replaceRule)})},addUserRule:function(e,t,a){var o="<td><textarea placeholder='"+chrome.i18n.getMessage("settings_rule_name")+"'>"+e+"</textarea></td>";o+="<td><textarea placeholder='"+chrome.i18n.getMessage("settings_rule_imageUrl_pattern")+"'>"+t+"</textarea></td>",o+='<td><textarea placeholder="'+chrome.i18n.getMessage("settings_rule_url_replace_code")+'">'+a+"</textarea></td>";var r="<tr>"+(o+="<td class='text_center'><span class=\"link_btn btn_test\">"+chrome.i18n.getMessage("settings_rule_test")+'</span> <span class="link_btn btn_export hidden">导出</span> <span class="link_btn btn_del">'+chrome.i18n.getMessage("settings_rule_delete")+"</span></td>")+"</tr>";$("#user_rule_wrap tbody").append(r)},getUserRuleByHtml:function(e){var t=$(e).find("textarea");return{site:this.escapeRule($(t[0]).val().trim()),srcPattern:this.escapeRule($(t[1]).val().trim()),replaceRule:this.escapeRule($(t[2]).val().trim())}},vaildateUserRule:function(e){return""!=e.site&&""!=e.srcPattern&&""!=e.replaceRule},saveUserRule:function(){var e=[],t=this;$("#user_rule_wrap tbody").find("tr").each(function(a,o){var r=t.getUserRuleByHtml(o);t.vaildateUserRule(r)&&e.push(r)}),G_CONFIG.saveUserRule(e),t.showUserRuleInfo()},escapeRule:function(e){return e},unescapeRule:function(e){return e}};$(function(){$("#dragSelect").next().text(currentI18n.options.drag_select),$("#dragDownload").next().text(currentI18n.options.drag_download),$("#autoConvertWebp").next().text(currentI18n.options.autoConvertWebp),optionOp.restore_options(),optionOp.bind()}),function(){for(var e=[],t="A";t<="Z";)e.push('<option value="'+t+'">'+t+"</option>"),t=String.fromCharCode(t.charCodeAt(0)+1);var a=localStorage.hotKey||"Z";$("#hotkey").append(e.join("")).val(a).change(function(){localStorage.hotKey=$(this).val()})}();