function aiparser(e){if(top==self){var t=0;chrome.runtime.sendMessage({cmd:"SET_GROUPS",groups:["主图","视频","SKU图片","详情"]});var n=document.querySelectorAll("#J_UlThumb img"),a=document.querySelectorAll(".J_TSaleProp a"),r=document.querySelectorAll("#description img");if(location.href.match("detail.m"))n=document.querySelectorAll(".preview-slider img"),r=document.querySelectorAll("#modules-desc img"),(u=(u=document.querySelector("a.app-video"))?u.dataset.video:"")&&new VItem({src:u,group:"视频",groupIndex:1},t++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",tabId:_tabInfo.id,item:e})});var o=1;n.forEach(function(e,t){v({src:e.src,alt:"主图-"+h(o++,2),group:"主图",groupIndex:0})});var i=1;a.forEach(function(e,t){var n=e.style.backgroundImage.match(/(\/\/.*)"/);n&&v({src:n=n=location.protocol+n[1],group:"SKU图片",groupIndex:2,alt:"SKU-"+h(i++,2)+"-"+$(e).parent().attr("title")})});var c=1;r.forEach(function(e,t){var n=e.dataset.ksLazyload||e.src;n.match("img-tmdetail.alicdn.com/tps/i3/T1BYd_XwFcXXb9RTPq-90-90.png")||n.match("spaceball.gif")||v({alt:"详情-"+h(c++,2),src:n,group:"详情",groupIndex:3})});for(var d=document.querySelectorAll("script"),s=0;s<d.length;s++)if(d[s].innerText){if(imgVedioID=d[s].innerText.match(/"imgVedioID":"(\d+)"/),imgVedioID&&(imgVedioID=imgVedioID[1],userId=d[s].innerText.match(/"userId":"(\d+)"/),userId=userId?userId[1]:"",imgVedioID&&userId)){var u="https://cloud.video.taobao.com/play/u/"+userId+"/p/1/e/6/t/1/"+imgVedioID+".mp4";new VItem({src:u,group:"视频",groupIndex:1},t++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",tabId:_tabInfo.id,item:e})})}var m=d[s].innerText.match(/"httpsDescUrl".*?"(.*?)"/);m&&0==r.length&&(m=m[1],fetch(m).then(e=>e.text()).then(e=>{e.match(/<img.*?>/g).forEach(e=>{var t=e.match('src="(.*)"')[1];t=t.replace(/^\/\//,"https://"),v({alt:"详情-"+h(c++,2),src:t,group:"详情",groupIndex:3})})}));var l=d[s].innerText.match(/"valFlashUrl".*?"(.*?)"/);if(l){var p=l[1].replace(/(\/\/cloud\.video\.taobao\.com\/play\/u\/\d+\/p\/\d+\/e\/)\d+(\/t\/)\d+(.+)swf/,"$16$21$3mp4");(p=p.replace(/^\/\//,"https://")).indexOf(".mp4")>0&&new VItem({src:p,group:"视频",alt:"详情视频",groupIndex:1},t++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",tabId:_tabInfo.id,item:e})})}var f=d[s].innerText.match(/({"valItemInfo":[\s\S]*?)\);/);if(f)try{for(var I in(f=JSON.parse(f[1])).propertyPics)for(var g=0;g<f.valItemInfo.skuList.length;g++)if(f.valItemInfo.skuList[g].pvs.indexOf(I.replace(/^;/,"").replace(/;$/,""))>=0){v({src:f.propertyPics[I][0],group:"SKU图片",groupIndex:2,alt:"SKU-"+h(i++,2)+"-"+f.valItemInfo.skuList[g].names});break}}catch(e){}}}function h(e,t){return(Array(t).join(0)+e).slice(-t)}function v(e){e.src.match("^//")&&(e.src=`https:${e.src}`),new ParsedPItem(e,t++,_tabInfo,function(e){e.width>300&&chrome.runtime.sendMessage({cmd:"ADD_IMG",tabId:_tabInfo.id,item:e})})}}window.aiparser=aiparser,function(){var e,t,n,a,r,o,i,c=0,d=!1;function s(){a=location.href.match("\\bid=(\\d+)")[1],r=document.getElementsByName("microscope-data")[0].content.match(/userid=(\d+)/)[1];for(var t=document.querySelectorAll("script"),d=0;d<t.length;d++)if(o=t[d].innerText.match(/"spuId":"(\d+)"/)){o=o[1];break}i=`jsonp${parseInt(1e4*Math.random())}`;var s=document.createElement("script");s.innerText=`\n        window.${i} = function(data){\n            window.postMessage({\n                topic: 'fatkun-tbview',\n                data: data\n            }, '*')\n        };\n        localStorage.fatkun_ua = window.getUA();\n    `,document.body.append(s),window.addEventListener("message",function(t){"fatkun-tbview"==t.data.topic&&function(t){if(t.rateDetail){var a=t.rateDetail.paginator.page;t.rateDetail.rateList.forEach((e,t)=>{!function e(t,n,a){t.pics.forEach((e,r)=>{new ParsedPItem({src:u(e),alt:`${a}-${n+1}-${t.id}-图片-${r+1}`,group:`第${a}页-第${n+1}条评论`,groupIndex:20*(a-1)+n},c++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_IMG",type:"ftk-tb-review",tabId:_tabInfo.id,item:e})})});t.videoList.forEach((e,r)=>{new VItem({src:u(e.cloudVideoUrl),group:`第${a}页-第${n+1}条评论`,alt:`${a}-${n+1}-${t.id}-${r+1}-视频`,groupIndex:20*(a-1)+n},c++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",type:"ftk-tb-review",tabId:_tabInfo.id,item:e})}),new ParsedPItem({src:u(e.coverUrl),group:`第${a}页-第${n+1}条评论`,alt:`${a}-${n+1}-${t.id}-${r+1}-视频封面`,groupIndex:20*(a-1)+n},c++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_IMG",type:"ftk-tb-review",tabId:_tabInfo.id,item:e})})});t.appendComment&&e(t.appendComment,n,a)}(e,t,a)})}e<n&&(e++,setTimeout(m.bind(this,e),5e3))}(t.data.data)})}function u(e){if(!e.match(/^http/))return location.protocol+e}function m(e){var t=document.createElement("script"),n=`${Date.now()}_${parseInt(1e4*Math.max(.1,Math.random()))}`;t.src=`https://rate.tmall.com/list_detail_rate.htm?itemId=${a}&spuId=${o}&sellerId=${r}&order=3&currentPage=${e}&append=0&content=1&tagId=&posi=&picture=1&groupId=&ua=${encodeURIComponent(localStorage.fatkun_ua)}&needFold=0&_ksTS=${n}&callback=${i}`,document.body.appendChild(t)}c=0;var l=0,p=setInterval(function(){l>20&&clearInterval(p),l++,$('a[href="#J_Reviews"]').length>0&&($(`<li class="item-desc-tabview-item" style="cursor: default;">\n                <button id="ftk-review-download-btn" style="cursor: pointer;">\n                    <img style="width:16px;vertical-align:middle;margin-right:4px;" src="${chrome.extension.getURL("/icon-small.png")}"/>\n                    <span>下载</span>\n                </button>\n                <span>第</span>\n                <input id="fatkun-review-page-input-from" type="number" value="1" style="width: 4em"/>\n                <span>到</span>\n                <input id="fatkun-review-page-input-to" type="number" value="10" style="width: 4em"/>\n                <span>页评论图片</span>\n            </li>`).insertAfter($('a[href="#J_Reviews"]').closest("li")).find("button").click(function(){return d||(s(),d=!0),t=document.getElementById("fatkun-review-page-input-from").value,t=parseInt(t),n=document.getElementById("fatkun-review-page-input-to").value,n=parseInt(n),e=t,chrome.runtime.sendMessage({cmd:"OPEN-OUTPUT",type:"ftk-tb-review"},function(){setTimeout(function(){m(e)},2e3)}),!1}),clearInterval(p))},500)}();