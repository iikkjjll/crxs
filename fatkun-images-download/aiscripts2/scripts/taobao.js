function aiparser(e){if(top==self){var t=0;chrome.runtime.sendMessage({cmd:"SET_GROUPS",groups:["主图","视频","SKU图片","详情"]});var n=document.querySelectorAll("#J_UlThumb img"),a=document.querySelectorAll(".J_TSaleProp a"),r=document.querySelectorAll("#description img");location.href.match("h5.m.taobao.com")&&(n=document.querySelectorAll(".siema-wrapper img"),r=document.querySelectorAll(".detail-desc img"));var o=1;n.forEach(function(e){e.src.match(/tbvideo.jpg/)||f({alt:"主图-"+p(o++,2),src:e.dataset.src||e.src,group:"主图",groupIndex:0})});var c=1;a.forEach(function(e){var t=e.style.backgroundImage.match(/(\/\/.*)"/);t&&f({src:t=t=location.protocol+t[1],group:"SKU图片",groupIndex:2,alt:"SKU-"+p(c++,2)+"-"+$(e).find("span").text()})});var i=1;r.forEach(function(e){var t=e.dataset.src||e.dataset.ksLazyload||e.src;t.match("img-tmdetail.alicdn.com/tps/i3/T1BYd_XwFcXXb9RTPq-90-90.png")||t.match("spaceball.gif")||f({alt:"详情-"+p(i++,2),src:t,group:"详情",groupIndex:3})});var d,s=document.querySelector('meta[name="microscope-data"]'),u=document.querySelectorAll("script");if(s&&(userId=s.content.match(/userid=(\d+);/),userId)){userId=userId[1];for(var m=0;m<u.length;m++)if(u[m].innerText&&!d&&(d=u[m].innerText.match(/"videoId":"(\d+)"/))){d=d[1];var l="https://cloud.video.taobao.com/play/u/"+userId+"/p/1/e/6/t/1/"+d+".mp4";new VItem({src:l,group:"视频",groupIndex:1},t++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",tabId:_tabInfo.id,item:e})});break}}}function p(e,t){return(Array(t).join(0)+e).slice(-t)}function f(e){e.src.match("^//")&&(e.src=location.protocol+e.src),new ParsedPItem(e,t++,_tabInfo,function(e){e.width>300&&chrome.runtime.sendMessage({cmd:"ADD_IMG",tabId:_tabInfo.id,item:e})})}}window.aiparser=aiparser,function(){var e,t,n,a,r,o,c,i=0,d=!1;function s(){a=location.href.match("\\bid=(\\d+)")[1],r=document.getElementsByName("microscope-data")[0].content.match(/userid=(\d+)/)[1];for(var t=document.querySelectorAll("script"),d=0;d<t.length;d++)if(o=t[d].innerText.match(/"spuId":"(\d+)"/)){o=o[1];break}c=`jsonp${parseInt(1e4*Math.random())}`;var s=document.createElement("script");s.innerText=`\n        window.${c} = function(data){\n            window.postMessage({\n                topic: 'fatkun-tbview',\n                data: data\n            }, '*')\n        };\n    `,document.body.append(s),window.addEventListener("message",function(t){"fatkun-tbview"==t.data.topic&&function(t){if(t.comments){var a=t.currentPageNum;t.comments.forEach((e,t)=>{!function e(t,n,a){t.photos.forEach((e,t)=>{new ParsedPItem({src:u(e.url),alt:`${a}-${n+1}-图片-${t+1}`,group:`第${a}页-第${n+1}条评论`,groupIndex:20*(a-1)+n},i++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_IMG",type:"ftk-tb-review",tabId:_tabInfo.id,item:e})})});var r=[];t.video&&r.push(t.video);r=r.concat(t.videos||[]);r.forEach((e,t)=>{new VItem({src:u(e.cloudVideoUrl),group:`第${a}页-第${n+1}条评论`,alt:`${a}-${n+1}-${t+1}-视频`,groupIndex:20*(a-1)+n},i++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_VIDEO",type:"ftk-tb-review",tabId:_tabInfo.id,item:e})}),new ParsedPItem({src:u(e.coverUrl),group:`第${a}页-第${n+1}条评论`,alt:`${a}-${n+1}-${t+1}-视频封面`,groupIndex:20*(a-1)+n},i++,_tabInfo,function(e){chrome.runtime.sendMessage({cmd:"ADD_IMG",type:"ftk-tb-review",tabId:_tabInfo.id,item:e})})});t.append&&e(t.append,n,a)}(e,t,a)})}e<n&&(e++,setTimeout(m.bind(this,e),5e3))}(t.data.data)})}function u(e){if(!e.match(/^http/))return location.protocol+e}function m(e){var t=document.createElement("script"),n=`${Date.now()}_${parseInt(1e4*Math.max(.1,Math.random()))}`,o=Math.random();t.src=`https://rate.taobao.com/feedRateList.htm?auctionNumId=${a}&userNumId=${r}&currentPageNum=${e}&pageSize=20&rateType=3&orderType=sort_weight&attribute=&sku=&hasSku=true&folded=0&ua=${o}&_ksTS=${n}&callback=${c}`,document.body.appendChild(t)}i=0;var l=0,p=setInterval(function(){l>20&&clearInterval(p),l++,$('a[shortcut-label="查看累计评论"]').length>0&&($(`<li class="item-desc-tabview-item" style="cursor: default;display: flex; align-items: center;">\n                <button id="ftk-review-download-btn" style="cursor: pointer;">\n                    <img style="width:16px;vertical-align:middle;margin-right:4px;" src="${chrome.extension.getURL("/icon-small.png")}"/>\n                    <span>下载</span>\n                </button>\n                <span>第</span>\n                <input id="fatkun-review-page-input-from" type="number" value="1" style="width: 4em"/>\n                <span>到</span>\n                <input id="fatkun-review-page-input-to" type="number" value="10" style="width: 4em"/>\n                <span>页评论图片</span>\n            </li>`).insertAfter($('a[shortcut-label="查看累计评论"]').closest("li")).find("button").click(function(){return d||(s(),d=!0),t=document.getElementById("fatkun-review-page-input-from").value,t=parseInt(t),n=document.getElementById("fatkun-review-page-input-to").value,n=parseInt(n),e=t,chrome.runtime.sendMessage({cmd:"OPEN-OUTPUT",type:"ftk-tb-review"},function(){setTimeout(function(){m(e)},2e3)}),!1}),clearInterval(p))},500)}();