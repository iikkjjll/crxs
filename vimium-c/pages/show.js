"use strict";var VData=null;(function(){function n(n){(n?addEventListener:removeEventListener)("wheel",e,{passive:false,capture:true})}function e(n){n.ctrlKey&&(n.preventDefault(),n.stopImmediatePropagation(),c(n))}function t(){var n=T.scrollWidth;A.style.height=T.scrollHeight+"px",A.style.width=n+"px",A.style.display=""}function i(n,e){var t,i;if(e.preventDefault(),VData.url){for(i in t=document.createElement("a"),Object.setPrototypeOf(n,null),n)t.setAttribute(i,n[i]);t.href=VData.url,r(t,e)}}function r(n,e){var t=document.createEvent("MouseEvents");return t.initMouseEvent("click",true,true,window,1,0,0,0,0,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,0,null),n.dispatchEvent(t)}function o(n,e){2===e||-2===e?n.rotate(45*e):n.zoom(e/10,true)}function u(n,e){try{n=(e||decodeURIComponent)(n)}catch(n){}return n}function a(n,e){var t=R("#bodyTemplate"),i=document.importNode(t.content.querySelector("#"+n),true);return e||document.body.insertBefore(i,t),i}function c(n){if(n.altKey)return n.stopImmediatePropagation(),i({download:VData.file||""},n);switch(VData.type){case"url":i({target:"_blank"},n);break;case"image":if(VData.error)return;var e=n.ctrlKey||n.metaKey;h().then(function(n){return w(n,e)}).catch(m)}}function l(n){n.preventDefault(),T.onclick&&T.onclick(n)}function f(n,e){n="number"==typeof n?["math","copy","search","ERROR","status","paste","url"][n]:n,R("#textTip").dataset.text=I("t_"+n)||n,R(".colon").dataset.colon=I("colon")+I("NS");var i=R("#textBody");return e?(i.textContent="string"!=typeof e?e.join(" "):e,T.onclick=s):i.classList.add("null"),t()}function s(n){var e,t=getSelection();if(!(""+t)){if("image"===VData.type&&VData.url){if("Range"===t.type)return;if(n.preventDefault(),(e=navigator.clipboard)&&e.write)return void(null!=C?Promise.resolve(C):fetch(VData.url,{cache:"force-cache",referrer:"no-referrer"}).then(function(n){return n.blob()}).catch(function(){return d(VData.url),0}).then(function(n){return C=n})).then(function(n){var t,i,r;if(n)return t={"image/png":new Blob([n],{type:"image/png"}),"text/html":new Blob,"text/plain":new Blob([VData.url],{type:"text/plain"})},i=function(){return e.write([new ClipboardItem(t)])},F&&F.f<86?i():((r=document.createElement("img")).src=VData.url,VData.file&&r.setAttribute("aria-title",r.alt=VData.file),t["text/html"]=new Blob([r.outerHTML],{type:"text/html"}),i().catch(function(){return delete t["text/html"],i()}))}).catch(function(n){console.log(n),d(VData.url)})}d("url"===VData.type?R("#textBody").textContent:VData.url,n)}}function d(n,e){n&&window.VApi&&(e&&e.preventDefault(),VApi.p({H:16,s:n}))}function m(n){n&&console.log("%o",n)}function h(){var e,t=window.Viewer;return t?Promise.resolve(t):((function(n){if(!R('link[href="'+n+'"]')){var e=document.createElement("link");e.rel="stylesheet",e.href=n,document.head.insertBefore(e,R('link[href$="show.css"]'))}})("../lib/viewer.min.css"),(e="Viewer","../lib/viewer.min.js",window[e]?Promise.resolve(window[e]):window[e]=new Promise(function(n){var t=document.createElement("script");t.src="../lib/viewer.min.js",t.onload=function(){var t=window[e];n(t)},document.head.appendChild(t)})).then(function(e){return e.setDefaults({navbar:false,shown:function(){A.style.display="none"},viewed:function(){U&&(n(false),U(true))},hide:function(){A.style.display="",n(true),U&&U(false)}}),e}))}function w(n,e){var t,i=scrollX||scrollY,r=getSelection();return"Range"===r.type&&r.collapseToStart(),(t=j=j||new n(T)).scrollbarWidth=0,t.hiding&&(t.isShown=false),t.isShown||t.show(),t.hiding=false,i&&scrollTo(0,0),t.viewed?(t.zoomTo(1),t):(Object.defineProperty(t,"initialImageData",{configurable:true,enumerable:true,get:function(){return S},set:function(n){var t,i,r,o;S=n,j&&!e&&(e=true,o=(r=1*(t=j.imageData).naturalHeight)-t.height,t.left-=((i=1*t.naturalWidth)-t.width)/2,t.top-=o/2,t.width=i,t.height=r,t.ratio=1)}}),new Promise(function(n,e){U=function(i){U=null,i?n(t):e("failed to view the image")}}))}function g(){P&&(URL.revokeObjectURL(P),P="")}function b(n){var e=n.split(":",1)[0];switch(e.toLowerCase()){case"thunder":case"flashget":case"qqdl":n=n.slice(e.length+3).split("&",1)[0];break;default:return""}try{n=atob(n)}catch(n){return""}return n.startsWith("AA")&&n.endsWith("ZZ")&&(n=n.slice(2,-2)),n.startsWith("[FLASHGET]")&&n.endsWith("[FLASHGET]")&&(n=n.slice(10,-10)),b(n)||n}function p(){console.log("Failed to visit the predicted URL, so go back to the original version."),v(),VData.auto=false,window.onhashchange()}function v(){var n=false;return"once"===VData.auto&&(VData.auto=false,n=true),n&&y(),n}function y(n){var e,t,i=VData.type;i&&(e="#!"+i+" "+(VData.incognito?"incognito=1&":"")+(VData.file?"download="+(F?F.r.encodeAsciiComponent:encodeURIComponent)(VData.file)+"&":"")+(VData.auto?"auto="+("once"===VData.auto?"once":1)+"&":"")+(VData.pixel?"pixel=1&":"")+VData.original,VData.full=e,n||(t=x(e,z,true),history.replaceState(t,"","")))}function x(n,e,t){var i,r,o,u;if(-1===e)return n;if(i=[],t)n=encodeURIComponent(n);else try{n=atob(n)}catch(e){n=""}for(r=0,o=n;r<o.length;r++)i.push(o[r].charCodeAt(0));for(u=0;u<i.length;u++)i[u]=255&(i[u]^e>>>8*(3&u));if(n=String.fromCharCode.apply(String,i),t)n=btoa(n);else try{n=decodeURIComponent(n)}catch(e){n=""}return n}function k(n){return VData.full?location.href.split("#",1)[0]+VData.full:n}var R,I,_,L,T,A,U,j,S,z,E,P,C,$,B,F=chrome.extension&&chrome.extension.getBackgroundPage();F&&F.r&&F.r.V||(F=null),R=function(n){return document.querySelector(n)},I=chrome.i18n.getMessage,_={},L=document.body,T=null,A=R("#bgLink"),U=null,j=null,S=null,z=+window.name||0,E=/\.(avif|bmp|gif|icon?|jpe?g|a?png|tiff?|webp)(?=[.\-_]|\b)/i,P="",C=null,chrome.i18n.getMessage("lang1")&&(document.title=I("vDisplay")||document.title),window.onhashchange=function(){var e,r,o,s,d,m,h,w,R,U,S,M;for(T&&((function(){if(g(),C=null,$&&($(),$=null),"image"===VData.type){n(false);var e=document.body.classList;e.remove("pixel"),e.remove("filled"),T.removeAttribute("src"),T.onerror=T.onload=null,j&&(j.destroy(),j=null)}})(),A.style.display="none",T.remove(),T=null),(VData=Object.create(null)).o=k,e=location.hash,r="",o="",B||!e&&F&&F.l&&F.l.De.Ze?(e=B||F.l.De.Ze(),B="",/^[^:]+[ &]data:/i.test(e)&&(z=-1),s=x(e,z=z||Math.floor(4294967296*Math.random())||3286711320,true),history.state?history.pushState(s,"",""):history.replaceState(s,"",""),window.name=""+z):e||!history.state||(z?(e=x(history.state,z,false),window.name=""+z):history.replaceState(null,"","")),VData.full=e,e.length<3||(e.startsWith("#!image")?(e=e.slice(7),r="image"):e.startsWith("#!url")&&(e=e.slice(5),r="url")),e=e.startsWith("%20")?e.slice(3):e.trim(),d=0;d=e.indexOf("&")+1;e=e.slice(d))if(h=(m=e.slice(0,d).indexOf("="))>0?e.slice(0,m):"",w=m>0?e.slice(m+1,d-1):"","download"===h)o=(o=u(w).split(/\||\uff5c| [-\xb7] /,1)[0].trim()).replace(/[\r\n"]/g,""),VData.file=o;else if(w=w.toLowerCase(),"auto"===h)VData.auto="once"===w?w:"true"===w||"false"!==w&&parseInt(w,10)>0;else if("pixel"===h)VData.pixel="1"===w||"true"===w;else{if("incognito"!==h)break;VData.incognito="true"===w||"false"!==w&&parseInt(w,10)>0}switch((e=u(e,e.includes(":")||e.includes("/")?decodeURI:null).trim())?e.toLowerCase().startsWith("javascript:")?r=e=o=VData.file="":F?(R=F.r.V(e,null,-2),F.r.B<=2&&(e=R)):e.startsWith("//")?e="http:"+e:/^([-.\dA-Za-z]+|\[[\dA-Fa-f:]+])(:\d{2,5})?\//.test(e)&&(e="http://"+e):"image"===r&&(r=""),VData.type=r,/^data:/i.test(e)&&(e="data:"+e.slice(5)),VData.url=VData.original=e,r){case"image":VData.auto&&(U=(function(n){function e(n){try{return new URL(n)}catch(n){}return null}function t(n){try{n=decodeURIComponent(n||"")}catch(n){}return n}var i,r,o,u,a,c,l,f,s,d,m,h,w,g,b,p,v,y,x=n;if(!(i=e(n=F&&F.r.we(n,256)||n))||!/^(ht|s?f)tp/i.test(i.protocol))return null;if(r=i.origin,o=i.pathname,(u=i.search).length>10)for(a=0,c=u.slice(1).split("&");a<c.length;a++){if(f=(l=c[a]).split("=",1)[0],(d=s=l.slice(f.length+1)).length>7)if(!d.includes("://")&&/%(?:3[aA]|2[fF])/.test(d)&&(d=t(d).trim()),d.includes("/")&&null!=e(d)){if(/^(?:imgurl|mediaurl|objurl|origin(?:al)?|real\w*|src|url)$/i.test(f))return d;if(m=d.split("?")[0].split("/"),E.test(m[m.length-1])&&!/\bthumb/i.test(f))return d}else if("id"===f&&/&w=\d{2,4}&h=\d{2,4}/.test(u))return r+o+"?id="+s;if("name"===f&&/^(\d{2,4}x\d{2,4}|small)$/i.test(s)&&u.toLowerCase().includes("format="))return r+o+u.replace(d,"large")}if(h=null,(h=/[?&]s=\d{2,4}(&|$)/.exec(u))&&u.split("=").length<=3)return r+o;if(w=(u=o).lastIndexOf("/")+1,p=null,b=(g=(u=u.slice(w)).lastIndexOf("@")+1||u.lastIndexOf("!")+1)>2||E.test(u)){for(w+=g,u=u.slice(g),v=/(?:[.\-_]|\b)(?:[1-9]\d{2,3}[a-z]{1,3}[_\-]?|[1-9]\d?[a-z][_\-]?|0[a-z][_\-]?|[1-9]\d{1,3}[_\-]|[1-9]\d{1,2}(?=[.\-_]|\b)){2,6}(?=[.\-_]|\b)/gi;p=v.exec(u);h=p);h&&/.[_\-].|\d\dx\d/i.test(h[0])?(p=E.exec(u.slice(h.index+h[0].length)),y=h[0].length,p&&0===p.index&&(y+=p[0].length),u=o.slice((w+=h.index)+y),/[@!]$/.test(u||o.charAt(w-1))?u?u=u.slice(0,-1):w--:u||!p||0!==p.index||E.test(o.slice(Math.max(0,w-6),w))||(u=p[0])):(h=/\b([\da-f]{8,48})([_-][a-z]{1,2})\.[a-z]{2,4}$/.exec(u))?(w+=h.index+h[1].length,u=u.slice(h.index+h[1].length+h[2].length)):b=false}return b||g>2?b=b||0:(h=/_(0x)?[1-9]\d{2,3}(x0)?\./.exec(u))?u=u.slice(0,h.index)+u.slice(h.index+h[0].length-1):u.startsWith("thumb_")?u=u.slice(6):/^[1-9]\d+$/.test(u)&&+u>0&&+u<640?(w--,u=""):E.test(u)&&/^\/(small|(thumb|mw|orj)[1-9]\d{2,3})\//.test(o)?(b=true,u="/large"+o.slice(o.indexOf("/",1)),w=0):b=0,0!==b?r+o.slice(0,w)+u:x!==n?n:null})(e))&&(console.log("Auto predict a better URL:\n %o =>\n %o",e,U),e=VData.url=U),(T=a("shownImage")).onerror=function(){VData.url!==VData.original&&VData.url?p():(v(),VData.auto=false,this.onerror=this.onload=null,this.alt=VData.error=I("failInLoading")||"\xa0(fail in loading)\xa0",F&&F.l&&F.f>=60&&this.classList.add("broken"),setTimeout(t,34),this.onclick=function(n){F&&F.a.dt(VData.url)||(n.ctrlKey||n.shiftKey||n.altKey||!chrome.tabs||!chrome.tabs.update?i({target:"_top"},n):chrome.tabs.update({url:VData.url}))})},/[:.]/.test(e)?(T.onclick=c,T.onload=function(){var n,e,i,r,o,u,c,l,f=this.naturalWidth,s=this.naturalHeight;if(f<12&&s<12){if(VData.auto)return void p();if(f<2&&s<2)return console.log("The image is too small to see."),void this.onerror(null)}if(VData.original=VData.url,v(),((e=(n=VData.url.slice(0,6).toLowerCase()).startsWith("blob:"))||n.startsWith("data:")&&!this.src.startsWith("data"))&&(A.dataset.vimUrl=VData.original=VData.url=this.src,y(e?0:1)),this.onerror=this.onload=null,this.src.startsWith("blob:")||setTimeout(function(){T.src=T.src},0),t(),this.classList.add("zoom-in"),VData.pixel){for(L.classList.add("pixel"),devicePixelRatio,(i=a("snapshot-banner",true)).querySelector(".banner-close").onclick=function(){i.remove()},r=i.querySelectorAll("[data-i]"),o=0;o<r.length;o++)c=(u=r[o].dataset.i).endsWith("-t"),(l=I(c?u.slice(0,-2):u))&&(c?r[o].title=l:r[o].textContent=l);L.insertBefore(i,L.firstChild)}f>=.9*innerWidth&&L.classList.add("filled")},(function(n,e){var t,i,r,o,u=new Text,a=document.body,c=$=function(){e.removeEventListener("load",c),e.removeEventListener("error",c),clearTimeout(o),u.remove(),$===c&&($=null)};e.addEventListener("load",c,true),e.addEventListener("error",c,true),i=(t=n.slice(0,20).toLowerCase()).startsWith("blob:"),r=t.startsWith("data:"),i||r&&!(n.length<1e4)||(VData.incognito||F.l.on("showInIncognito"))&&/^(ht|s?f)tp|^data:/.test(t)&&"cache"in Request.prototype?(g(),a.replaceChild(u,e),Promise.resolve(_[n]||(F&&F.f<48?new Promise(function(e,t){var i=new XMLHttpRequest;i.responseType="blob",i.onload=function(){e(this.response)},i.onerror=function(n){t("Error: "+n.message)},i.open("GET",n,true),i.send()}):fetch(n,i||r?{}:{cache:"no-store",referrer:"no-referrer"}).then(function(n){return n.blob()}))).then(function(e){return _[n]=e,P=URL.createObjectURL(C=e)},function(){return n}).then(function(n){e.src=n,u.parentNode?a.replaceChild(e,u):a.appendChild(e)})):e.src=n,o=setTimeout(function(){!e.parentNode||e.scrollHeight>=24||e.scrollWidth>=80?c():u.parentNode||(a.insertBefore(u,e),u.data=I("loading")||"loading\u2026")},400)})(e,T)):(e=VData.url="",T.onerror(null),T.alt=VData.error=I("none")||"\xa0(null)\xa0"),o&&(VData.file=o=(function(n){var e,t,i,r;if(n&&!/.\.[a-z]{3,4}\b/i.test(n)){if(e=E.exec(VData.url))return n+e[0];if((t=C?C.type.toLowerCase():"").startsWith("image/"))for(r in i={jpeg:"jpg",png:0,bmp:0,svg:0,gif:0,tif:0,ico:0})if(i.hasOwnProperty(r)&&t.includes(r))return i[r]||"."+r}})(o)||o,(S=o.split(/[/\\]+/)).length>1&&T.setAttribute("download",S[S.length-1]),T.alt=o,T.setAttribute("aria-title",o)),n(true);break;case"url":if(T=a("shownText"),e&&F){if(M=null,e.startsWith("vimium://")&&(M=F.r.K(e.slice(9),1,true)),"string"==typeof(M=null!==M?M:F.r.V(e,null,-1)))M=F.r.ae(M),M=F.r.Re(M);else{if(M instanceof F.Promise){M.then(function(n){f(n[1],n[0]||n[2]||"")});break}if(M instanceof F.Array){f(M[1],M[0]);break}}e=M}"string"==typeof e&&(e=b(e)||e),f(r,e);break;default:e="",(T=a("shownImage")).src="../icons/icon128.png",A.style.display="none",n(true)}A.dataset.vimUrl=e,o?(A.dataset.vimText=o,A.download=o):(A.removeAttribute("data-vim-text"),A.removeAttribute("download")),A.onclick=T?l:c},window.onhashchange(),window.onpopstate=function(){window.onhashchange()},window.onunload=g,L.ondrop=function(n){var e,t,i=n.dataTransfer.files;1===i.length&&(t=(e=i.item(0)).name,(e.type.startsWith("image/")||E.test(t))&&(n.preventDefault(),B="#!image download="+t+"&"+URL.createObjectURL(e),onhashchange()))},L.ondragover=L.ondragenter=function(n){var e=n.dataTransfer.items;1===e.length&&e[0].type.startsWith("image/")&&n.preventDefault()},document.addEventListener("keydown",function(n){if(("image"!==VData.type||!(function(n){var e,t,i,u,a,c,l;if(VData.error)return false;if(e=n.keyCode,"space"===(i=(t=window.VApi&&VApi.z?VApi.m({c:" ",e:n,i:e},8):32===e?"space":13===e?"enter":"").slice(t.lastIndexOf("-")+1)||t&&"-")||"enter"===i)return VData.pixel&&(a=(u=document.activeElement)&&document.querySelector("#snapshot-banner"))&&a.contains(u)?((c=a.querySelector(".banner-close")).contains(u)&&c.onclick(null),true):(n.preventDefault(),"enter"===i&&j&&j.isShown&&!j.hiding&&!j.played?j.play(true):j&&j.isShown&&!j.hiding||r(T,n),true);switch(l=0,t){case"c-=":case"m-=":case"+":case"=":case"up":l=1;break;case"left":l=-2;break;case"right":l=2;break;case"c--":case"m--":case"-":case"down":l=-1;break;default:return false}return n.preventDefault(),n.stopImmediatePropagation(),j&&j.viewed?o(j,l):h().then(w).then(function(n){o(n,l)}).catch(m),true})(n))&&(n.ctrlKey||n.metaKey)&&!n.altKey&&!n.shiftKey&&!n.repeat){var e=String.fromCharCode(n.keyCode);if("S"===e)return i({download:VData.file||""},n);if("C"!==e)return"A"===e?(function(n){"image"===VData.type&&(VData.error||j&&j.isShown&&!j.hiding?n.preventDefault():T.classList.toggle("invert"))})(n):void 0;s(n)}})})();